<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>立法院 - 人員清冊管理系統</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- 基礎設定 --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f0f2f5; }
        .container { 
            max-width: 900px; margin: 0 auto; background-color: #fff; 
            padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #1a237e; border-bottom: 2px solid #ffcc00; padding-bottom: 10px; }
        
        /* --- 公開顯示區 --- */
        #public-display {
            padding: 20px 0; display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 20px 10px; justify-content: center;
        }
        #public-display ul { list-style: none; padding: 0; margin: 0; display: contents; }
        #public-display ul li {
            text-align: center; border: 1px solid #eee; padding: 10px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; background: #fafafa;
        }
        #public-display ul li img {
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid #1a237e; 
            object-fit: cover; margin-bottom: 5px;
        }
        .member-id { font-size: 0.7em; color: #999; }
        .member-name { font-weight: bold; font-size: 0.95em; color: #333; margin: 2px 0; }
        .member-link-info { font-size: 0.7em; color: #007bff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }

        /* 按鈕樣式 */
        .action-btn {
            color: white; border: none; font-size: 10px; border-radius: 4px;
            cursor: pointer; display: block; width: 90px; padding: 5px;
            margin: 3px auto 0 auto !important; transition: 0.2s;
        }
        .edit-btn { background-color: #4b1a7e; } /* 紫色：修改資料 */
        .update-image-btn { background-color: #ff9800; }
        .delete-btn { background-color: #f44336; }
        .move-btn-container { display: flex; justify-content: space-between; width: 90px; margin-top: 5px; }
        .move-btn { background-color: #007bff; width: 43px !important; margin: 0 !important; }
        .action-btn:hover { opacity: 0.8; }

        /* --- 編輯區 --- */
        #edit-section { background-color: #e6f7ff; padding: 25px; border-radius: 8px; margin-top: 20px; border: 1px solid #b3e5fc; }
        #login-section { padding: 20px; background-color: #f5f5f5; border-radius: 8px; margin-top: 20px; }
        .hidden { display: none !important; }
        
        input { padding: 12px; margin-top: 8px; display: block; width: 100%; box-sizing: border-box; border-radius: 5px; border: 1px solid #ccc; }
        label { margin-top: 15px; display: block; font-weight: bold; color: #333; }
        
        .main-btn { border: none; padding: 12px; cursor: pointer; font-weight: bold; border-radius: 5px; margin-top: 15px; width: 100%; color: white; }
        #saveBtn { background-color: #4caf50; }
        #cancelEditBtn { background-color: #757575; margin-top: 10px; }
        #signOutBtn { background-color: #333; }
        #loginBtn { background-color: #1a237e; }
    </style>
</head>
<body>

<div class="container">
    <h1><i class="fas fa-users-cog"></i> 成員資料管理中心</h1>
    
    <div id="public-display"><p style="text-align: center;">連線中...</p></div>

    <hr>

    <div id="login-section">
        <h2>管理員驗證</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="密碼">
        <button id="loginBtn" class="main-btn" onclick="signIn()">登入</button>
    </div>

    <div id="edit-section" class="hidden">
        <h2 id="form-title"><i class="fas fa-user-plus"></i> 新增成員資料</h2>
        
        <input type="hidden" id="editing-doc-id">

        <label>成員名稱 (職稱/暱稱)：</label>
        <input type="text" id="editor-text" placeholder="例如：班長">

        <label>個人網頁連結：</label>
        <input type="text" id="editor-link" placeholder="例如：info-leader.html">

        <div id="image-upload-group">
            <label>上傳頭像 (僅新增時必選)：</label>
            <input type="file" id="image-upload" accept="image/*">
        </div>
        
        <button id="saveBtn" class="main-btn" onclick="handleSave()">儲存資料</button>
        <button id="cancelEditBtn" class="main-btn hidden" onclick="resetForm()">取消修改</button>
        <button id="signOutBtn" class="main-btn" onclick="signOut()">登出</button>
        
        <p id="save-message" style="text-align:center; font-weight:bold; margin-top:10px;"></p>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyACnoimIASfb1rb59SbgLDkUmyYR6ODbUU",
        authDomain: "llwb-ed686.firebaseapp.com",
        projectId: "llwb-ed686",
        storageBucket: "llwb-ed686.firebasestorage.app", 
        messagingSenderId: "940345852074",
        appId: "1:940345852074:web:7a30cca5a6d997a92350d3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage();
    const COLLECTION_REF = db.collection("content");

    auth.onAuthStateChanged(user => {
        document.getElementById('login-section').classList.toggle('hidden', !!user);
        document.getElementById('edit-section').classList.toggle('hidden', !user);
    });

    async function signIn() {
        try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value); } 
        catch (err) { alert("錯誤: " + err.message); }
    }
    function signOut() { auth.signOut(); resetForm(); }

    // 即時讀取
    COLLECTION_REF.orderBy("timestamp", "asc").onSnapshot(snapshot => {
        let html = '<ul>';
        snapshot.docs.forEach((doc, index) => {
            const data = doc.data();
            html += `
                <li>
                    <p class="member-id">編號 ${index+1}</p>
                    <img src="${data.imageUrl || ''}">
                    <p class="member-name">${data.text}</p>
                    <p class="member-link-info">${data.link || '#'}</p>
                    ${auth.currentUser ? `
                        <div class="move-btn-container">
                            <button class="action-btn move-btn" onclick="moveContent('${doc.id}', 'up', ${index})"><i class="fas fa-arrow-left"></i></button>
                            <button class="action-btn move-btn" onclick="moveContent('${doc.id}', 'down', ${index})"><i class="fas fa-arrow-right"></i></button>
                        </div>
                        <button class="action-btn edit-btn" onclick="prepareEdit('${doc.id}', '${data.text}', '${data.link}')">修改連結</button>
                        <button class="action-btn update-image-btn" onclick="triggerUpdateImg('${doc.id}', '${data.imageUrl}')">更換圖片</button>
                        <button class="action-btn delete-btn" onclick="deleteItem('${doc.id}', '${data.imageUrl}')">刪除</button>
                    ` : ''}
                </li>`;
        });
        document.getElementById('public-display').innerHTML = html + '</ul>';
    });

    // 進入編輯狀態
    window.prepareEdit = (id, text, link) => {
        document.getElementById('editing-doc-id').value = id;
        document.getElementById('editor-text').value = text;
        document.getElementById('editor-link').value = link;
        document.getElementById('form-title').innerHTML = '<i class="fas fa-edit"></i> 修改成員資料';
        document.getElementById('saveBtn').textContent = "儲存修改";
        document.getElementById('cancelEditBtn').classList.remove('hidden');
        document.getElementById('image-upload-group').classList.add('hidden'); // 修改文字時隱藏上傳控制
        window.scrollTo({ top: document.getElementById('edit-section').offsetTop, behavior: 'smooth' });
    };

    function resetForm() {
        document.getElementById('editing-doc-id').value = "";
        document.getElementById('editor-text').value = "";
        document.getElementById('editor-link').value = "";
        document.getElementById('form-title').innerHTML = '<i class="fas fa-user-plus"></i> 新增成員資料';
        document.getElementById('saveBtn').textContent = "儲存並發佈";
        document.getElementById('cancelEditBtn').classList.add('hidden');
        document.getElementById('image-upload-group').classList.remove('hidden');
        document.getElementById('image-upload').value = "";
    }

    async function handleSave() {
        const id = document.getElementById('editing-doc-id').value;
        const text = document.getElementById('editor-text').value.trim();
        const link = document.getElementById('editor-link').value.trim();
        if (!text) return alert("請填寫名稱");

        const msg = document.getElementById('save-message');
        msg.textContent = "處理中...";

        try {
            if (id) {
                // 修改模式
                await COLLECTION_REF.doc(id).update({ text, link });
                alert("修改成功！");
            } else {
                // 新增模式
                const file = document.getElementById('image-upload').files[0];
                if (!file) return alert("新增時請選擇圖片");
                const ref = storage.ref(`images/${Date.now()}_${file.name}`);
                const snap = await ref.put(file);
                const url = await snap.ref.getDownloadURL();
                await COLLECTION_REF.add({ text, link: link || "#", imageUrl: url, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                alert("新增成功！");
            }
            resetForm();
        } catch (err) { alert("失敗: " + err.message); }
        msg.textContent = "";
    }

    // 刪除、移動、更換圖片邏輯維持
    async function deleteItem(id, url) { if(confirm("確定刪除？")) { if(url) await storage.refFromURL(url).delete(); await COLLECTION_REF.doc(id).delete(); } }
    
    window.moveContent = async (id, dir, idx) => {
        const snap = await COLLECTION_REF.orderBy("timestamp", "asc").get();
        const docs = snap.docs; const targetIdx = dir === 'up' ? idx - 1 : idx + 1;
        if (targetIdx < 0 || targetIdx >= docs.length) return;
        const curDoc = docs[idx], tarDoc = docs[targetIdx];
        const curTs = curDoc.data().timestamp, tarTs = tarDoc.data().timestamp;
        await COLLECTION_REF.doc(curDoc.id).update({ timestamp: tarTs });
        await COLLECTION_REF.doc(tarDoc.id).update({ timestamp: curTs });
    };

    window.triggerUpdateImg = (id, oldUrl) => {
        const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
        input.onchange = async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const ref = storage.ref(`images/${Date.now()}_${file.name}`);
            const snap = await ref.put(file); const url = await snap.ref.getDownloadURL();
            await COLLECTION_REF.doc(id).update({ imageUrl: url });
            if(oldUrl) try { await storage.refFromURL(oldUrl).delete(); } catch(e){}
            alert("圖片更新成功");
        };
        input.click();
    };
</script>
</body>
</html>
